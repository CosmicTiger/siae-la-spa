<app-modal [(open)]="open" [title]="title" (closed)="closed.emit($event)">
  <form [formGroup]="form" (ngSubmit)="submit()" class="space-y-4">
    <ng-container *ngFor="let f of schema">
      <ng-container *ngIf="isVisible(f)">
        <ng-container [ngSwitch]="f.type || 'text'">
          <!-- group -->
          <ng-container *ngSwitchCase="'group'">
            <div class="border rounded p-3">
              <h4 class="text-sm font-semibold mb-2">{{ f.label }}</h4>
              <div [formGroupName]="f.key" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <ng-container *ngFor="let sf of f.fields">
                  <ng-container *ngIf="isVisible(sf)">
                    <ng-container [ngSwitch]="sf.type || 'text'">
                      <div *ngSwitchCase="'checkbox'" class="field">
                        <label class="flex items-center gap-2">
                          <input type="checkbox" [formControlName]="sf.key" class="checkbox" />
                          {{ sf.label || sf.key }}
                        </label>
                      </div>
                      <div *ngSwitchDefault class="field">
                        <label class="label">{{ sf.label || sf.key }}</label>
                        <input class="input"
                          [type]="sf.type === 'password' ? 'password' : (sf.type === 'date' ? 'date' : 'text')"
                          [formControlName]="sf.key" />
                      </div>
                    </ng-container>
                  </ng-container>
                </ng-container>
              </div>
            </div>
          </ng-container>

          <!-- select -->
          <ng-container *ngSwitchCase="'select'">
            <div class="field">
              <label class="label">{{ f.label }}</label>
              <select class="input" [formControlName]="f.key">
                <option *ngFor="let o of f.options" [value]="o.value">{{ o.label }}</option>
              </select>
            </div>
          </ng-container>

          <!-- checkbox -->
          <ng-container *ngSwitchCase="'checkbox'">
            <div class="field">
              <label class="flex items-center gap-2">
                <input type="checkbox" class="checkbox" [formControlName]="f.key" />
                {{ f.label || f.key }}
              </label>
            </div>
          </ng-container>

          <!-- default (input) -->
          <ng-container *ngSwitchDefault>
            <div class="field">
              <label class="label">{{ f.label }}</label>
              <input class="input"
                [type]="f.type === 'password' ? 'password' : (f.type === 'date' ? 'date' : (f.type === 'email' ? 'email' : 'text'))"
                [formControlName]="f.key" />
            </div>
          </ng-container>

        </ng-container>
      </ng-container>
    </ng-container>

    <div class="flex items-center justify-end gap-2">
      <button type="button" class="btn-outline" (click)="close(false)">Cancelar</button>
      <button type="submit" class="btn" [disabled]="loading || form.invalid">Aceptar</button>
    </div>

    <p *ngIf="error" class="text-red-600 text-sm">{{ error }}</p>
  </form>
</app-modal>
